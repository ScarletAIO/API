import { VirusTotalDTO } from "../../../dtos/message.dto";
import { saveError } from "../../../functions/logger";

const api = require("api")("@virustotal/v3.0#7r415jxl3ofbsw8");

export default new class VirusTotal {
    private sdk = api;
    private key = process.env.VIRUSTOTAL_KEY as string;

    /**
     * @description This function will check the file against VirusTotal
     *
     * @param {string} file
     * @return {*}  {(Promise<VirusTotalDTO|any>)}
     */
    async detect(file:string): Promise<VirusTotalDTO|any> {
        const post = this.sdk.post("/files", {
            file: file,
        }, {
            Accept: "application/json",
            "x-apikey": this.key,
            "Content-Type": "multipart/mixed"
        });

        return post.then((res:any) => {
            return this.getAnalysis(res.data.data.id);
        })
        .catch((err:any) => {
            saveError(err);
            return err;
        })
    }

    /**
     * @description This function will get the analysis of the file
     *
     * @private
     * @param {string} id
     * @return {*}  {(Promise<VirusTotalDTO|any>)}
     */
    private async getAnalysis(id:string): Promise<VirusTotalDTO|any> {
        return await this.sdk.analysis({
            id: id,
            "x-apikey": this.key,
        })
        .then((res: VirusTotalDTO) => {
            return res;
        })
        .catch((err:any) => {
            saveError(err);
            return err;
        });
    }
}
